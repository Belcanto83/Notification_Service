# Сервис уведомлений

## Решаемая задача

Сервис управления рассылками сообщений клиентам на внешнее `API` и получения статистики по выполненным рассылкам.
Для увеличения скорости работы сервиса рассылки осуществляются параллельно в асинхронном режиме с использованием `Celery` и `Celery beat`.

## Описание

Реализовано `API` для:

* добавления нового клиента в справочник со всеми его атрибутами
* обновления данных атрибутов клиента
* удаления клиента из справочника
* добавления новой рассылки со всеми её атрибутами
* получения общей статистики по созданным рассылкам и количеству отправленных сообщений по ним с группировкой по статусам
* получения детальной статистики отправленных сообщений по конкретной рассылке
* обновления атрибутов рассылки
* удаления рассылки
* обработки активных рассылок и отправки сообщений клиентам

## Логика рассылки

* После создания новой рассылки, если текущее время больше времени начала и меньше времени окончания - выбираются из справочника все клиенты, которые подходят под значения фильтра, указанного в этой рассылке и запускается отправка сообщений для всех этих клиентов на внешнее API.
* Если создаётся рассылка с временем старта в будущем - отправка сообщений начинается автоматически по наступлению этого времени без дополнительных действий со стороны пользователя системы.
* По ходу отправки сообщений собирается статистика для последующего формирования отчётов.

## Выполненные дополнительные задания
* (1) организовано тестирование написанного кода (минимальное покрытие кода тестами на данный момент)
* (2) организована автоматическая сборка/тестирование с помощью GitHub Actions
* (3) подготовлен docker-compose для запуска всех сервисов проекта одной командой (в начальной стадии)
* (5) по адресу /docs/ открывается страница Swagger UI и в ней отображается описание разработанного API
* (6) частично реализован администраторский Web UI для управления рассылками и получения статистики по отправленным сообщениям
* (9) удаленный сервис может быть недоступен, долго отвечать на запросы или выдавать некорректные ответы. Организована обработка ошибок и откладывание запросов при неуспехе для последующей повторной отправки. Задержки в работе внешнего сервиса никак не должны оказывать влияние на работу сервиса рассылок.

## Предпосылки

* установлен `git`
* установлены `python3 & pip`
* установлена СУБД `PostgreSQL`
* установлены `docker & docker-compose`
* установлен `менеджер баз данных` (например, DBeaver)

## Запуск проекта в тестовом режиме на `localhost`

Для запуска проекта необходимо:

1. Клонировать репозиторий проекта:

```bash
git clone https://github.com/Belcanto83/Notification_Service.git
```

2. Перейти в папку проекта, активировать виртуальное окружение и установить зависимости:

```bash
. venv/Scripts/activate && \
pip install -r requirements.txt
```

3. В корне проекта создать файл `.env.without_docker` и указать в нём переменные окружения:

```base
SECRET_KEY=...
DEBUG=True
DB_ENGINE=django.db.backends.postgresql
DB_NAME=notification_service
DB_USER=...
DB_PASSWORD=...
DB_HOST=localhost
DB_PORT=5432
API_TOKEN=...
REDIS_HOST=localhost
```

4. В файле `notification_service/settings.py` выполнить настройку соответствующего окружения:

```
load_dotenv('.env.without_docker')
```

5. Создать базу данных (БД) в PostgreSQL с именем **notification_service**:

```bash
createdb -U <username> notification_service
```

6. Применить миграции к БД:

```bash
python manage.py migrate
```

7. Выполнить команду:

```bash
docker-compose -f docker-compose-redis.yml up -d
```

8. Выполнить команду:

```bash
celery -A notification_service worker -l info # Linux
celery -A notification_service worker -l info -P threads # Windows
```

9. Выполнить команду:

```bash
python manage.py runserver
```

10. Выполнить команду:

```bash
celery -A notification_service beat -l info
```

## Запуск проекта с использованием `Docker`

1. В корне проекта создать файл `.env` и указать в нём переменные окружения:

```base
SECRET_KEY=...
DEBUG=True
DB_ENGINE=django.db.backends.postgresql
DB_NAME=notification_service
DB_USER=...
DB_PASSWORD=...
DB_HOST=postgresql_db
DB_PORT=5432
API_TOKEN=...

REDIS_HOST=redis_db
BROKER=redis://redis_db:6379/1
BACKEND=redis://redis_db:6379/2
```

2. В файле `notification_service/settings.py` выполнить настройку соответствующего окружения:

```
load_dotenv('.env')
```

3. Запуск всех контейнеров одной командой:

```bash
docker-compose up -d [--build]
```

4. Проверка всех логов (или по конкретному имени сервиса):

```bash
docker-compose logs [<service_name>]
```

5. Остановка всех контейнеров и удаление всех созданных `volumes`:

```bash
docker-compose down -v
```
